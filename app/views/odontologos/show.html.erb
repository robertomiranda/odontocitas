<div class="wrapper_home_odontologos">
  <p class="saludo">Buenos Dias</p>
  <div class="menu_lateral">
      <div class="nombre_odontologo">
        <p class="n_apellido">  
          DR . <%= @odontologo.apellido.partition(" ")[0] %>.
        </p>
      </div>

      <div class="lista_navegacion_home_odontologos">
        <div class="item_navegacion_home_odonto calendario_menu">
          <%= image_tag "odontologo/iconos_menu/icono_calendario_over.png", :class=>'imagen_icono_menu_lateral '%>
          <%= link_to 'Calendario', odontologo_path(current_user) , :class=> 'activo_menu link_item_registrado ' %>
        </div>
        <div class="item_navegacion_home_odonto">
          <%= image_tag "odontologo/iconos_menu/icono_agendar.png", :class=>'imagen_icono_menu_lateral'%>
          <%= link_to 'Agendar', agendar_url , class: 'link_item_registrado link_agendar' %>
        </div> 
        <div class="item_navegacion_home_odonto disponibilidad_menu">
          <%= image_tag "odontologo/iconos_menu/icono_disponibilidad.png", :class=>'imagen_icono_menu_lateral'%>
          <%= link_to 'Disponibilidad', disponibilidad_url , class: 'link_item_registrado' %>
        </div> 
        <div class="item_navegacion_home_odonto" style="color:#e6e6e6 !important;">
          <%= image_tag "odontologo/iconos_menu/icono_finanzas_off.png", :class=>'imagen_icono_menu_lateral'%>
          Finanzas
        </div> 
        <div class="item_navegacion_home_odonto" style="color:#e6e6e6 !important;">
          <%= image_tag "odontologo/iconos_menu/icono_reportes_off.png", :class=>'imagen_icono_menu_lateral'%>
          Reportes
        </div> 
        <div class="item_navegacion_home_odonto">
          <%= image_tag "odontologo/iconos_menu/icono_paciente.png", :class=>'imagen_icono_menu_lateral'%>
          <%= link_to 'Pacientes', pacientes_odontologo_url , class: 'link_item_registrado' %>
        </div> 
        <div class="item_navegacion_home_odonto">
          <%= image_tag "odontologo/iconos_menu/icono_historialdecitas.png", :class=>'imagen_icono_menu_lateral'%>
          <%= link_to 'Historial de citas', citas_odontologo_url , class: 'link_item_registrado' %>
        </div> 
        <div class="item_navegacion_home_odonto">
          <%= image_tag "odontologo/iconos_menu/icono_perfil.png", :class=>'imagen_icono_menu_lateral'%>
          <%= link_to 'Perfil', perfil_odontologo_url , class: ' link_item_registrado' %>
        </div> 
      </div>
  </div>
  <div class="menu_superior_agendar">
    <div class="dia_especifico">
      <div class="flecha_izq_camb_dia"></div>
      <div class="texto_dia_especifico">
      </div>
      <div class="flecha_der_camb_dia"></div>
    </div>
    <div class="menu_dia_sem_mes">
        <%= image_tag "agendar/boton_dia_over.png", class:'menu_dia'%>
        <%= image_tag "agendar/boton_semana.png", class:'menu_sem'%>
        <%= image_tag "agendar/boton_mes.png", class:'menu_mes'%>
    </div>
  </div>
  <div class="contenedor_navegacion_home_odontologo">
    <div class="arriba">
      <div id="mini_calendario">

      </div>
      <div class="dia">
        <p class="nombre_dia"></p>
        <p class="numero"></p>
      </div>
    </div>
    <div class="abajo" id="template_pacientes_cita">
       <table class="tabla_citas_para_hoy">
        <!--
        <tr class="elemento">
          <td class="hora"></td><td class="nombre_paciente" title="prueba de tooltip"></td>
          <td><%= image_tag "odontologo/icono_editar.png", class: 'editar_cita'%></td><td><%= image_tag "odontologo/icono_cancelar.png", class: 'cancelar_cita'%></td>
          <td><%= image_tag "odontologo/icono_confirmar.png", class: 'confirmar_cita'%></td><td><%= image_tag "odontologo/icono_no_asistio.png", class: 'asistio_cita'%></td>
        </tr>
        -->
      </table>

    </div>
  </div>

</div>


<div class="form_cita">
        <%= image_tag "icono_cerrar.png" ,  :class => 'cerrar_form_cita' %>
          <form name ="cita">
          <div class="form_cita_izquierda naranja">
              <div class="titulo_form">
                Información del Paciente
              </div>
              <div class="field">
                &nbsp;&nbsp;<%= label_tag 'nombre'  %> :
                <%= text_field_tag 'nombre_paciente' ,nil,:class=> 'registro_campo'%>
              </div>
              <div class="field">
                &nbsp;&nbsp;&nbsp;<%= label_tag 'correo' %> :
                <%= text_field_tag 'correo_paciente' ,nil, :class=> 'registro_campo'%>
              </div>
              <div class="field">
                &nbsp;&nbsp;<%= label_tag 'celular'  %> :
                <%= text_field_tag 'celular_paciente',nil,:class=> 'registro_campo'%>
              </div>
               &nbsp;&nbsp; <label for="name" id="name_label">Comentarios del Paciente</label>
              <br> 
              <textarea id="comentarios_paciente_cita" cols="37" rows="15" readonly>
              </textarea>
         </div>

         <div class="form_cita_izquierda naranja" style="position:relative; top:-11px;">
              <div class="titulo_form">
                Información de la Cita
              </div>
              <div class="field">
                &nbsp;&nbsp;<%= label_tag 'Motivo Consulta'  %> :
                <%= text_field_tag 'motivo_consulta' ,nil,:class=> 'campo_cita'%>
              </div>
              <div class="field">
                &nbsp;&nbsp;&nbsp;<%= label_tag 'Modo Pago' %> :
                <%= text_field_tag 'modo_pago' ,nil, :class=> 'campo_cita'%>
              </div>
              <div class="field">
                &nbsp;&nbsp;&nbsp;<%= label_tag 'Medio Pago' %> :
                <%= text_field_tag 'medio_pago' ,nil, :class=> 'campo_cita'%>
              </div>
              
              <div class="fecha_cita" style="float:left; margin: 5px 0 0 11px;">
                <div style="with:100px; float:left;">
                  <label for="name" id="name_label">Fecha de <br> la cita</label> 
                </div>

                  <div class="styled_dropdown" style="width: 100px;height: 25px; float:left; margin-left:7px;">
                   <select id="mes_cita" disabled style="width :100px">
                    <option value="--">mm</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                  </select>
                  </div>

                  <div class="styled_dropdown" style="width: 60px;height: 25px; float:left; margin-left:7px;">
                  <select id="dia_cita" disabled>
                    <option value="--">dd</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                    <option value="26">26</option>
                    <option value="27">27</option>
                    <option value="28">28</option>
                    <option value="29">29</option>
                    <option value="30">30</option>
                    <option value="31">31</option>
                  </select>
                  </div>
              </div>

               <br>
               <br>
               <br>
                <div class="hora_cita" style="float:left; margin-left:11px;" >
                  <div style="with:100px; float:left;">
                    <label for="name" id="name_label">Hora de <br> la cita</label> 
                  </div>
                   <div class="styled_dropdown" style="width: 60px;height: 25px; float:left; margin-left:7px;">
                       <select id="hora_cita" disabled>
                          <option value="--">h</option>
                          <option value ='12'>00</option>
                          <option value ='1'>1</option>  
                          <option value ='2'>2</option>
                          <option value ='3'>3</option>
                          <option value ='4'>4</option>  
                          <option value ='5'>5</option>
                          <option value ='6'>6</option>
                          <option value ='7'>7</option>  
                          <option value ='8'>8</option>
                          <option value ='9'>9</option>
                          <option value ='10'>10</option>  
                          <option value ='11'>11</option>
                      </select>
                  </div>

                  <div class="styled_dropdown" style="width: 60px;height: 25px; float:left; margin-left:7px;">
                   <select id="minutos_cita" disabled>
                      <option value="--">m</option>
                      <option value ='00'>00</option>
                      <option value ='15'>15</option>  
                      <option value ='30'>30</option>
                      <option value ='45'>45</option>
                  </select>
                 </div>

                 <div class="styled_dropdown" style="width: 60px;height: 25px; float:left; margin-left:7px;">
                   <select id="seccion_hora" disabled>
                      <option value="am">am</option>
                      <option value="pm">pm</option>
                  </select>
                 </div>

              </div>
              <br>
              <br>
              <div class="duracion_cita" style="margin: 12px 0 10px 11px;">
                  <div style="with:100px; float:left;">
                    <label for="name" id="name_label">Duracion de <br> la cita</label> 
                  </div>
                  
                  <div class="styled_dropdown" style="width: 60px;height: 25px; float:left; margin-left:7px;">
                     <select id="duracion_cita" disabled>
                        <option value="--">mm</option>
                        <option value ='15'>15</option>  
                        <option value ='30'>30</option>
                        <option value ='45'>45</option>
                        <option value ='60'>60</option>
                    </select>
                  </div>
              </div>
         </div>

         <div class="actions botonera_formulario">
            <ul class="all_botones_formulario_cita">
              <li>
                <%= submit_tag "Reagendar Cita",  :class => 'submit_cita btn_reagendar'   %>
                <%= submit_tag "Cancelar Cita",  :class => 'submit_cita btn_cancelar_cita '   %>
                <%= submit_tag "Cita Incumplida",  :class => 'submit_cita btn_incumplida'   %>
              </li>
              <li>
                <%= submit_tag "Cancelar",  :class => 'submit_cita btn_cancelar_reagendar'   %>
                <%= submit_tag "Aceptar",  :class => 'submit_cita btn_aceptar_reagendar'   %>
              </li>
              <li>
                <%= submit_tag "Continuar",  :class => 'submit_cita'   %>
              </li>
            </ul>
          </div>
        </form>

       
      </div>



<script id="template_citas" type="text/x-handlebars-template">
    {{#if tabla_citas_para_hoy}}
      {{#each tabla_citas_para_hoy}}
         <tr class="elemento">
            <td class="hora">{{hora}}</td>
            <td class="nombre_paciente" paciente="{{nombre_paciente}}" motivo="{{motivo}}" duracion= "{{duracion}}" medido_pago = "{{medido_pago}}" id_cita ="{{id_cita}}">
              <p class="nombre_paciente_adentro" paciente="{{nombre_paciente}}" motivo="{{motivo}}" duracion= "{{duracion}}" medido_pago = "{{medido_pago}}" id_cita ="{{id_cita}}">
                {{nombre_paciente}}
              </p>
            </td>
            <td><%= image_tag "odontologo/icono_editar.png", class: 'editar_cita_btn', id_cita: "{{id_cita}}"%></td>
            {{acciones_segun_estado estado_cita id_cita}}
          </tr>
      {{/each}}
    {{else}}
        <div class="titulo_form" style="position:relative;top:40px;left:300px;">
           No hay citas para hoy
        </div>
         
    {{/if}}
</script>

<script type="text/javascript">
  $(function () {

    //saco el id
    

     var adelante = 0;

     $('#mini_calendario').datepicker({
        inline: true,
        firstDay: 1,
        showOtherMonths: true,
        dayNamesMin: ['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'],
        monthNames: [ "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Dicimbre" ] ,
        //minDate: 0, no permitir fechas antes de hoy
        onSelect : function(date) {
            //alert(date);

            var fecha = $( "#mini_calendario" ).datepicker( "getDate" );
            //console.log(fecha.getDate());
            calendario_dia.calcular_distacia(fecha.getDate());
            calendario_dia.cambio_dia(fecha);
            //console.log('dia '+fecha.getDate()):
            calendario_dia.citasPorFecha(fecha.getFullYear(),parseInt(fecha.getMonth())+1,fecha.getDate());
        }
    });


     $('body').css('background','#E6E6E6');
     moment.lang('en', {
        weekdays : [
            "Domingo", "Lunes", "Martes", "Miercoles", "Jueves", "Viernes", "Sabado"
        ],
        weekdaysShort : ["Dom", "Lun", "Mar", "Mie", "Jue", "Vie", "Sab"],
        months : [
        "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio",
        "Agosto", "Septiembre", "Obtubre", "Noviembre", "Diciembre"
        ],
         monthsShort : [
            "Ene", "Feb", "Mar", "Abr", "May", "Jun",
            "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"
        ]
    });
  


     var misCitas,citas_dia;
      Citas = Backbone.Collection.extend({
        url :'/appointments',
        comparator : function(c){
          return parseInt(c.get("hora"));
        }
      });
      
      
      Pacientes = Backbone.Collection.extend({
        url : '/pacientes'
      });

    window.pacientes = new Pacientes;
    window.citas = new Citas;


  
        var calendario_dia = {
          init : function (){
            //Mie 26 de Jun del 2013
            var notificaion_dia = moment().format('ddd')+' '+moment().format('D')+' de '+moment().format('MMM')+' del '+moment().format('YYYY');
            $('.texto_dia_especifico').html(notificaion_dia);
            //
            //mis citas
            var miscitas1 = citas.where({odontologo_id: parseInt(id_odontologo), estado :'confirmada'});

            var miscitas2 = citas.where({odontologo_id: parseInt(id_odontologo), estado :'porconfirmar'});

            misCitas = _.union(miscitas1, miscitas2);
            //misCitas = citas.where({odontologo_id: parseInt(id_odontologo)});
            $('.nombre_dia').html(moment().format('dddd'));
            $('.numero').html(moment().format('D'));
            adelante = 0;
            $( "#mini_calendario" ).datepicker( "setDate",new Date());
            var fecha = $( "#mini_calendario" ).datepicker( "getDate");
            this.cambio_dia(fecha);
            this.citasPorFecha(moment().format('YYYY'),moment().format('M'),moment().format('D'));
            this.eventos();

            $('#medio_pago').attr('disabled', 'disabled');
            $('#motivo_consulta').attr('disabled', 'disabled');
            $('#modo_pago').attr('disabled', 'disabled');
            $('#minutos_cita').attr('disabled', 'disabled');
            $('#seccion_hora').attr('disabled', 'disabled');
          
            $('#nombre_paciente').attr('disabled', 'disabled');
            $('#correo_paciente').attr('disabled', 'disabled');
            $('#celular_paciente').attr('disabled', 'disabled');
          },
          init_whit_date : function (dia, mes , ano){
            //Date(2013-02-15);
            var fecha_nueva = new Date(ano+'-'+mes+'-'+dia);
            //
            //mis citas
            var miscitas1 = citas.where({odontologo_id: parseInt(id_odontologo), estado :'confirmada'});

            var miscitas2 = citas.where({odontologo_id: parseInt(id_odontologo), estado :'porconfirmar'});

            misCitas = _.union(miscitas1, miscitas2);

            //console.log(misCitas);

            //misCitas = citas.where({odontologo_id: parseInt(id_odontologo)});
            $('.nombre_dia').html(moment().format('dddd'));
            $('.numero').html(moment().format('D'));
            adelante = 0;
            $( "#mini_calendario" ).datepicker( "setDate",fecha_nueva);
            var fecha = $( "#mini_calendario" ).datepicker( "getDate");

            this.cambio_dia(fecha_nueva);
            //this.cambio_dia(fecha);
            this.citasPorFecha(ano,mes,dia);
            this.eventos();

            $('#medio_pago').attr('disabled', 'disabled');
            $('#motivo_consulta').attr('disabled', 'disabled');
            $('#modo_pago').attr('disabled', 'disabled');
            $('#minutos_cita').attr('disabled', 'disabled');
            $('#seccion_hora').attr('disabled', 'disabled');
          
            $('#nombre_paciente').attr('disabled', 'disabled');
            $('#correo_paciente').attr('disabled', 'disabled');
            $('#celular_paciente').attr('disabled', 'disabled');
          },
          eventos : function(){

            //navegacion dia-semana-mes
            $('.menu_sem').on('click',function(){
                window.location.href="../semana";
            }); 

            $('.menu_mes').on('click',function(){
                window.location.href="../mes";
            }); 

            //navegacion dias

            $('.flecha_der_camb_dia').on('click',function() {
              adelante++;
              var aumentar = '+'+adelante;
              $( "#mini_calendario" ).datepicker( "setDate", aumentar );
              var fecha = $( "#mini_calendario" ).datepicker( "getDate");
              if (!fecha) {
                adelante = 0;
              };
              //console.log(fecha);
              calendario_dia.cambio_dia(fecha);
              calendario_dia.citasPorFecha(fecha.getFullYear(),parseInt(fecha.getMonth())+1,fecha.getDate());
             
            });

             $('.flecha_izq_camb_dia').on('click',function() {
              //if (adelante != 0) {
                  adelante = adelante -1;
                  var disminuir = '+'+adelante;
                  $( "#mini_calendario" ).datepicker( "setDate", disminuir );
                  var fecha = $( "#mini_calendario" ).datepicker( "getDate");
                  //console.log(fecha);
                  calendario_dia.cambio_dia(fecha);
                  calendario_dia.citasPorFecha(fecha.getFullYear(),parseInt(fecha.getMonth())+1,fecha.getDate());
              //}

            });

             //abrir cita especificamente

            $('body').on('click','.nombre_paciente',function () {
                //semana.obtener_cita($(this).attr('id_cita'));
                calendario_dia.obtener_cita($(this).attr('id_cita'));
                console.log($(this).attr('id_cita'));
                $('.form_cita').attr('id_cita',$(this).attr('id_cita'));
                $('.pantalla_negra').fadeIn(1000);
                $('.form_cita').animate({
                  top : '50%',
                },1000);
            });

            $('body').on('click','.editar_cita_btn',function () {
                //semana.obtener_cita($(this).attr('id_cita'));
                calendario_dia.obtener_cita($(this).attr('id_cita'));
                console.log($(this).attr('id_cita'));
                $('.form_cita').attr('id_cita',$(this).attr('id_cita'));
                $('.pantalla_negra').fadeIn(1000);
                $('.form_cita').animate({
                  top : '50%',
                },1000);
            });


            //acciones en las citasa especificas

            $('.cerrar_form_cita').on('click', function() {
              $('.pantalla_negra').fadeOut(1000);
              $('.form_cita').animate({
                top : '-1500px'
              },1500);

              $('.all_botones_formulario_cita').animate({
                left:'0px'
              },1000);

              $('#mes_cita').attr('disabled', 'disabled');
              $('#dia_cita').attr('disabled', 'disabled');
              $('#duracion_cita').attr('disabled', 'disabled');
              $('#hora_cita').attr('disabled', 'disabled');
              $('#minutos_cita').attr('disabled', 'disabled');
              $('#seccion_hora').attr('disabled', 'disabled');
              $('#comentarios_paciente_cita').attr('readonly', 'readonly');

            });


             $('.btn_reagendar').on('click',function(e){
              e.preventDefault();
              //activar datos cita
              

              $('.all_botones_formulario_cita').animate({
                left:'-600px'
              },1000);
              $('#medio_pago').removeAttr( 'disabled');
              $('#motivo_consulta').removeAttr( 'disabled');
              $('#modo_pago').removeAttr( 'disabled');
              $('#mes_cita').removeAttr("disabled"); 
              $('#dia_cita').removeAttr("disabled"); 
              $('#duracion_cita').removeAttr("disabled"); 
              $('#hora_cita').removeAttr("disabled"); 
              $('#minutos_cita').removeAttr("disabled"); 
              $('#seccion_hora').removeAttr("disabled"); 
              $('#comentarios_paciente_cita').removeAttr("readonly"); 
              
            });

            $('.btn_cancelar_reagendar').on('click',function(e) {
              e.preventDefault();
              //desactivar datos cita

              calendario_dia.obtener_cita($('.form_cita').attr('id_cita'));
            
              $('#medio_pago').attr('disabled', 'disabled');
              $('#motivo_consulta').attr('disabled', 'disabled');
              $('#modo_pago').attr('disabled', 'disabled');
              $('#mes_cita').attr('disabled', 'disabled');
              $('#dia_cita').attr('disabled', 'disabled');
              $('#duracion_cita').attr('disabled', 'disabled');
              $('#hora_cita').attr('disabled', 'disabled');
              $('#minutos_cita').attr('disabled', 'disabled');
              $('#seccion_hora').attr('disabled', 'disabled');
              $('#comentarios_paciente_cita').attr('readonly', 'readonly');
              
              $('.all_botones_formulario_cita').animate({
                left:'0px'
              },1000);
            });

            $('.btn_aceptar_reagendar').on('click',function(e){
              e.preventDefault();

              $('.all_botones_formulario_cita').animate({
                left:'0px'
              },1000);

              $('#medio_pago').attr('disabled', 'disabled');
              $('#motivo_consulta').attr('disabled', 'disabled');
              $('#modo_pago').attr('disabled', 'disabled');
              $('#mes_cita').attr('disabled', 'disabled');
              $('#dia_cita').attr('disabled', 'disabled');
              $('#duracion_cita').attr('disabled', 'disabled');
              $('#hora_cita').attr('disabled', 'disabled');
              $('#minutos_cita').attr('disabled', 'disabled');
              $('#seccion_hora').attr('disabled', 'disabled');
              $('#comentarios_paciente_cita').attr('readonly', 'readonly');

              calendario_dia.reagendarCita($('.form_cita').attr('id_cita'));
            });

            //cancelar cita

            $('body').on('click','.cancelar_cita_btn',function () {
              var r=confirm("¿Seguro quieres cancelar la cita?");
              if (r==true){
                console.log('se quiere cancelar la cita ', $(this).attr('id_cita'));
                calendario_dia.cancelar_cita($(this).attr('id_cita'));
              }
                
            });

            $('.btn_cancelar_cita').on('click',function(e){
              e.preventDefault();
              var r=confirm("¿Seguro quieres cancelar la cita?");
              if (r==true){
                console.log('se quiere cancelar la cita ', $('.form_cita').attr('id_cita'));
                calendario_dia.cancelar_cita($('.form_cita').attr('id_cita'));
              }
            });
            $('body').on('click','.cita_confirmada',function () {
              //console.log($(this));
              if ($(this).attr('confirmada') == 'no') {
                calendario_dia.confirmar_cita($(this).attr('id_cita'), $(this));
              }
              
            });

            $('body').on('click','.asistio_btn',function () {
              //console.log($(this).attr('id_cita'));
              calendario_dia.no_asistio($(this).attr('id_cita'), $(this));
            });

          },
          cambio_dia : function (date) {
            console.log('estes es el dia');
              console.log(date.getDay());
                $('.numero').html(date.getDate());
                var dia, mes;
                switch(date.getDay()){
                  case 0:
                    $('.nombre_dia').html('Domingo');
                    dia = 'Dom';
                  break;
                  case 1:
                    $('.nombre_dia').html('Lunes');
                    dia = 'Lun';
                  break;
                   case 2:
                   $('.nombre_dia').html('Martes');
                   dia = 'Mar';
                  break;
                   case 3:
                   $('.nombre_dia').html('Miércoles');
                   dia = 'Mie';
                  break;
                   case 4:
                   $('.nombre_dia').html('Jueves');
                   dia = 'Jue';
                  break;
                   case 5:
                   $('.nombre_dia').html('Viernes');
                   dia = 'Vie';
                  break;
                  case 6:
                    $('.nombre_dia').html('Sábado');
                    dia = 'Sab';
                  break;
                }

                switch(date.getMonth()){
                  case 0:
                    mes ="Ene";
                  break;
                  case 1:
                    mes ="Feb";
                  break;
                   case 2:
                   mes ="Mar";
                  break;
                   case 3:
                   mes ="Abr";
                  break;
                   case 4:
                   mes ="May";
                  break;
                   case 5:
                  mes ="Jun";
                  break;
                  case 6:
                   mes ="Jul";
                  break;
                  case 7:
                    mes ="Ago";
                  break;
                   case 8:
                   mes ="Sep";
                  break;
                   case 9:
                   mes ="Oct";
                  break;
                   case 10:
                   mes ="Nov";
                  break;
                   case 11:
                  mes ="Dic";
                  break;
                }

                var notificaion_dia = dia+' '+date.getDate()+' de '+mes+' del '+date.getFullYear();
                $('.texto_dia_especifico').html(notificaion_dia);
          },
          calcular_distacia : function(dia) {
            adelante = dia - parseInt(moment().format('D'));
          },
          citasPorFecha : function(ano,mes,dia){
                    citas_dia = _.map(misCitas, function(c){ if (c.get('ano')==ano && c.get('mes')==mes && c.get('dia')==dia) {return c}; });
                    citas_dia = _.without(citas_dia, undefined);
                    console.log('aca estan las citas del dia');
                    console.log(citas_dia);
                    var pacientes_mios = new Array();

                    if (citas_dia.length < 1) {

                        var source   = $("#template_citas").html();
                        var template = Handlebars.compile(source);
                        //var html_1 = template({tabla_citas_para_hoy : pacientes_mios});
                        //console.log(html_1);
                        $('.tabla_citas_para_hoy').html(template({tabla_citas_para_hoy : pacientes_mios}));


                    }else{

                        for (var i =0 ; i < citas_dia.length; i++) {
                            var obj,nom;

                            var h = citas_dia[i].get('hora');
                            var p = pacientes.where({id:citas_dia[i].get('paciente_id')})[0];
                            nom = p.get('nombre')+' '+p.get('apellido') ;

                            h=parseFloat(h)/60;
                            var n= String(h).split(".");
                            if(n[1]){
                              var minutos;
                              switch(n[1]){
                                case '25':
                                  minutos = '15';
                                break;
                                case '5' :
                                  minutos = '30';
                                break;
                                case '75' :
                                  minutos = '45';
                                break;
                                }

                                if (n[0] > 12) {
                                  n[0] = n[0] -12;
                                  n[0] = String(n[0])+':'+minutos+' pm';
                                }else{
                                  n[0] = String(n[0])+':'+minutos+' am';
                                }

                            }else{
                              if (n[0] > 12) {
                                  n[0] = n[0] -12;
                                  n[0] = String(n[0])+':00 pm';
                              }else{
                                 n[0] = String(n[0])+':00 am';
                              }
                            }
                            

                            obj ={
                              hora:n[0],
                              nombre_paciente:nom,
                              motivo :citas_dia[i].get('motivo'),
                              duracion : citas_dia[i].get('duracion'),
                              estado_cita : citas_dia[i].get('estado'),
                              medido_pago : citas_dia[i].get('medido_pago'),
                              id_cita : citas_dia[i].id
                            }
                            pacientes_mios.push(obj);

                            
                        };

                        console.log(pacientes_mios);

                        var source   = $("#template_citas").html();
                        var context = Handlebars.compile(source);
                        //var html_1 = context({tabla_citas_para_hoy : pacientes_mios});
                        //console.log(html_1);
                        $('.tabla_citas_para_hoy').html(context({tabla_citas_para_hoy : pacientes_mios}));

                        $('.nombre_paciente_adentro').tipper({
                            formatter: function($target) {
                              return "<small>Paciente:</small> <strong>" + $target.attr("paciente")  
                                      +" <br> <small>Motivo:</small> <strong>" + $target.attr("motivo") +"<br><small>duracion:</small>  <strong>"+
                                      $target.attr("duracion") + "</strong>" +'<br>' +'<small>Id Cita:</small><strong>'+ $target.attr("id_cita") ;
                            }
                        });

                    };
                    
          },
          obtener_cita  : function(id_cita){
          //console.log(misCitas);
          var c = _.map(misCitas, function(c){ if (c.get('id')==id_cita ) {return c}; });
          c = _.without(c, undefined)[0];

          var p = pacientes.where({id:c.get('paciente_id')})[0];

          //console.log(cita[0]);
          //console.log(p);
          this.llenarFormularioCita(c,p);
        },
        llenarFormularioCita : function(cita,paci){
          
          $('#medio_pago').val(cita.get('medio_pago'));
          $('#motivo_consulta').val(cita.get('motivo'));
          $('#modo_pago').val(cita.get('modo_pago'));
          $('#mes_cita').val(cita.get('mes'));
          $('#dia_cita').val(cita.get('dia'));
          $('#duracion_cita').val(cita.get('duracion'));
          $('#comentarios_paciente_cita').val(cita.get('comentarios'));
          //console.log(this.hora_humanos(cita.get('hora')).split(" "));
          
          var hora_h = this.hora_humanos(cita.get('hora')).split(" ");
          var hora_h1 =  hora_h[0].split(":");
          $('#hora_cita').val(hora_h1[0]);
          $('#minutos_cita').val(hora_h1[1]);
          $('#seccion_hora').val(hora_h[1]);
          
          $('#nombre_paciente').val(paci.get('nombre')+' '+paci.get('apellido'));
          $('#correo_paciente').val(paci.get('correo'));
          $('#celular_paciente').val(paci.get('celular'));
          
        },
        hora_humanos : function(hora_minutos){
              hora_minutos=parseFloat(hora_minutos)/60;
              var n= String(hora_minutos).split(".");
              if(n[1]){
                var minutos;
                switch(n[1]){
                  case '25':
                    minutos = '15';
                  break;
                  case '5' :
                    minutos = '30';
                  break;
                  case '75' :
                    minutos = '45';
                  break;
                  }

                  if (n[0] > 12) {
                    n[0] = n[0] -12;
                    n[0] = String(n[0])+':'+minutos+' pm';
                  }else{
                    n[0] = String(n[0])+':'+minutos+' am';
                  }

              }else{
                if (n[0] > 12) {
                    n[0] = n[0] -12;
                    n[0] = String(n[0])+':00 pm';
                }else{
                   n[0] = String(n[0])+':00 am';
                }
              }
              return n[0];
          },
          reagendarCita :function (id_cita) {

              var c = _.map(misCitas, function(c){ if (c.get('id')==id_cita ) {return c}; });
              c = _.without(c, undefined)[0];
              //if( c.get('tipo_consulta') == "offline"){
                
                console.log(c);

                var hora_cita = $('#hora_cita').val();
                var minutos_cita = $('#minutos_cita').val();
                var seccion = $('#seccion_hora').val();
                console.log('hora cita '+hora_cita);
                console.log('minutos cita '+minutos_cita);
                console.log('seccion hora' + seccion);
                if ( seccion=="pm") {
                      hora_cita = parseInt(hora_cita)+12;
                      hora_cita = parseInt(hora_cita) * 60;
                      hora_cita = parseInt(hora_cita) + parseInt(minutos_cita);
                  }else{
                      hora_cita = parseInt(hora_cita) * 60;
                      hora_cita = parseInt(hora_cita) + parseInt(minutos_cita);
                  }


               //console.log(citas);

                citas.create({
                  ano: c.get('ano'),
                  comentarios: $('#comentarios_paciente_cita').val(),
                  dia: $('#dia_cita').val(),
                  duracion: $('#duracion_cita').val(),
                  estado: 'confirmada',
                  hora: hora_cita,
                  medio_pago: $('#medio_pago').val(),
                  mes: $('#mes_cita').val(),
                  modo_pago: $('#modo_pago').val(),
                  motivo: $('#motivo_consulta').val(),
                  odontologo_id: c.get('odontologo_id'),
                  paciente_id: c.get('paciente_id'),
                  tipo_consulta: c.get('tipo_consulta'),
                });
                //console.log(citas);

                c.save({'estado':'reagandada'},{
                  success:function(){
                    alert('se actualizo correctamente');
                      $('.pantalla_negra').fadeOut(1000);
                      $('.form_cita').animate({
                        top : '-1500px'
                      },1500);
                      //calendario_dia.init();
                      //por ahora ya que no esta sirviendo apropiadamente se llama dos veces :S
                      location.reload(); 
                    }
                });

            },
            cancelar_cita : function(id_cita){
              var c = _.map(misCitas, function(c){ if (c.get('id')==id_cita ) {return c}; });
              c = _.without(c, undefined)[0];

              c.save({'estado':'cancelada'},{
                  success:function(){
                      $('.pantalla_negra').fadeOut(1000);
                      $('.form_cita').animate({
                        top : '-1500px'
                      },1500);
                      //calendario_dia.init();
                      //por ahora ya que no esta sirviendo apropiadamente se llama dos veces :S
                      location.reload(); 
                    }
                });
            },
            confirmar_cita : function(id_cita, $elem){
              var c = _.map(misCitas, function(c){ if (c.get('id')==id_cita ) {return c}; });
              c = _.without(c, undefined)[0];

              c.save({'estado':'confirmada'},{
                  success:function(){
                      $elem.attr('src','/assets/odontologo/icono_confirmar_over.png');
                      //calendario_dia.init();
                      //por ahora ya que no esta sirviendo apropiadamente se llama dos veces :S
                      //location.reload(); 
                    }
                });
            },
            no_asistio: function(id_cita, $elem){
              var c = _.map(misCitas, function(c){ if (c.get('id')==id_cita ) {return c}; });
              c = _.without(c, undefined)[0];
              //console.log(c);
              //mes
              if (c.get('mes')==moment().format('M') && moment().format('D')==c.get('dia') && moment().format('YYYY')==c.get('ano') ) {
                if (parseInt(c.get('hora')) < this.obtener_hora_now_formato()) {
                  c.save({'estado':'noasistio'},{
                      success:function(){
                          $elem.attr('src','/assets/odontologo/icono_confirmar_over.png');
                          $elem.parent().prev().html('noasistio');
                          $elem.parent().html(
                                        '<img src="assets/historial_citas/icono_editar_activo.png" class ="activar_desplegar_mostrar_cita"  id_cita='+c.id+'>&nbsp;&nbsp;&nbsp;'+
                                         '<img src="assets/historial_citas/cancelar_inactivo.png" class =""  id_cita='+c.id+'>&nbsp;&nbsp;&nbsp;'+
                                         '<img src="assets/historial_citas/confirmar_inactivo.png" class =""  id_cita='+c.id+'>&nbsp;&nbsp;&nbsp;'+
                                         '<img src="assets/historial_citas/asistio_inactivo.png" class =""  id_cita='+c.id+'>&nbsp;&nbsp;&nbsp;');
                          //calendario_dia.init();
                          //por ahora ya que no esta sirviendo apropiadamente se llama dos veces :S
                          //location.reload(); 
                        }
                  });
                }
              }else{
                alert('no ah pasado el dia de esta cita, si quieres la puedes cancelar');
              }
              /*
              console.log(moment().format('M'));
              console.log(c.get('mes'));
              console.log(moment().format('D'));
              console.log(c.get('dia'));
              console.log(moment().format('YYYY'));
              console.log(c.get('ano'));*/
              
              
            },
            obtener_hora_now_formato : function(){
              return parseInt(moment().format('H'))*60+parseInt(moment().format('m'));
            }

        }


        Rutas = Backbone.Router.extend({
            routes: {
                '' :'index',
                'fecha/:id': 'show'
            },

            index: function(){
              $.when(pacientes.fetch(),citas.fetch()).done(function(){
                  calendario_dia.init();
              });
            },

            show: function(id){

                $.when(pacientes.fetch(),citas.fetch()).done(function(){
                  var fecha = id.split('-');
                  console.log(fecha);
                  calendario_dia.init_whit_date(fecha[0],fecha[1],fecha[2]);
                });
                
            },

        });

        new Rutas;
        Backbone.history.start();

        Handlebars.registerHelper('acciones_segun_estado' ,function ( estado, id_cita ) {
              var imagenes_mostrar;
              if (estado == "confirmada") {
                imagenes_mostrar = '<td><img alt="Icono_cancelar" class="cancelar_cita_btn" id_cita='+id_cita+' src="/assets/odontologo/icono_cancelar.png"></td>'+
                           '<td><img alt="Icono_cancelar" confirmada="no" class="cita_confirmada" id_cita='+id_cita+' src="/assets/odontologo/icono_confirmar_over.png"></td>'+
                           '<td><img alt="Icono_no_asistio" class="asistio_btn" id_cita='+id_cita+' src="/assets/odontologo/icono_asistio.png"></td>';
              }else{
                imagenes_mostrar = '<td><img alt="Icono_cancelar" class="cancelar_cita_btn" id_cita='+id_cita+' src="/assets/odontologo/icono_cancelar.png"></td>'+
                           '<td><img alt="Icono_cancelar" confirmada="no" class="cita_confirmada" id_cita='+id_cita+' src="/assets/odontologo/icono_confirmar.png"></td>'+
                           '<td><img alt="Icono_no_asistio" class="" id_cita='+id_cita+' src="/assets/odontologo/icono_asistio.png"></td>';
              };
              
        return new Handlebars.SafeString(
           imagenes_mostrar
        );
      });

  })
</script>
